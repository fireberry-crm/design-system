name: Publish Design System

on:
  workflow_dispatch:

# Prevent concurrent deployments
concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  build:
    name: Build Package
    runs-on: ubuntu-22.04
    permissions:
      contents: read
      attestations: write
      id-token: write

    outputs:
      version: ${{ steps.package-info.outputs.version }}
      name: ${{ steps.package-info.outputs.name }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20.x
          registry-url: 'https://registry.npmjs.org/'
          cache: 'npm'
          cache-dependency-path: ${{ github.workspace }}/package-lock.json

      - name: Get package information
        id: package-info
        run: |
          echo "version=$(node -p "require('./package.json').version")" >> $GITHUB_OUTPUT
          echo "name=$(node -p "require('./package.json').name")" >> $GITHUB_OUTPUT

      - name: Install dependencies
        run: npm ci

      - name: Type check
        run: npm run type-check

      - name: Build package
        run: npm run build

      - name: Install Playwright Browsers
        run: npx playwright install --with-deps

      - name: Start Storybook for tests
        run: |
          npm run storybook -- --ci --port 6006 > storybook.log 2>&1 &
          echo $! > storybook.pid
          npx --yes wait-on http://127.0.0.1:6006

      - name: Run Storybook tests
        run: npm run test -- --url http://127.0.0.1:6006 --ci
        env:
          CI: true

      - name: Stop Storybook
        if: always()
        run: |
          if [ -f storybook.pid ]; then
            kill $(cat storybook.pid) || true
            rm storybook.pid
          fi

      - name: Generate build attestation
        uses: actions/attest-build-provenance@v3
        with:
          subject-path: 'dist/**/*'

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: package-dist
          path: |
            dist/
            README.md
            package.json
          retention-days: 1
          compression-level: 6

      - name: Build Storybook
        run: npm run build-storybook

      - name: Upload Storybook artifacts
        uses: actions/upload-artifact@v4
        with:
          name: storybook-static
          path: storybook-static/
          retention-days: 1
          compression-level: 6

  deploy-storybook:
    name: Deploy Storybook to S3
    needs: build
    runs-on: ubuntu-22.04
    permissions:
      contents: read
      id-token: write # required for AWS OIDC

    environment:
      name: storybook
      url: https://design-system.fireberry.com

    steps:
      - name: Download Storybook artifacts
        uses: actions/download-artifact@v5
        with:
          name: storybook-static
          path: storybook-static/

      - name: Validate required AWS variables
        run: |
          set -euo pipefail
          [ -n "${{ secrets.AWS_ROLE_ARN_DESIGN_SYSTEM }}" ] || { echo "Missing secret AWS_ROLE_ARN_DESIGN_SYSTEM" >&2; exit 1; }
          [ -n "${{ vars.AWS_REGION }}" ] || { echo "Missing variable AWS_REGION" >&2; exit 1; }
          [ -n "${{ vars.AWS_CLOUDFRONT_DISTRIBUTION_ID_DESIGN_SYSTEM }}" ] || { echo "Missing variable AWS_CLOUDFRONT_DISTRIBUTION_ID_DESIGN_SYSTEM" >&2; exit 1; }

      - name: Configure AWS credentials using OIDC
        uses: aws-actions/configure-aws-credentials@v5
        with:
          role-to-assume: ${{ secrets.AWS_ROLE_ARN_DESIGN_SYSTEM }}
          aws-region: ${{ vars.AWS_REGION }}
          role-session-name: GitHubActions-StorybookDeploy

      - name: Deploy Storybook to S3
        run: |
          aws s3 sync --delete \
            --cache-control "public, max-age=31536000, immutable" \
            --exclude "*.html" \
            storybook-static/ ${{ secrets.AWS_S3_BUCKET_DESIGN_SYSTEM }}

          # HTML files with shorter cache for updates
          aws s3 sync \
            --cache-control "public, max-age=300" \
            --include "*.html" \
            storybook-static/ ${{ secrets.AWS_S3_BUCKET_DESIGN_SYSTEM }}

      - name: Invalidate CloudFront distribution (if configured)
        run: |
          aws cloudfront create-invalidation \
            --distribution-id ${{ vars.AWS_CLOUDFRONT_DISTRIBUTION_ID_DESIGN_SYSTEM }} \
            --paths "/*"

  publish-npm:
    name: Publish to npm
    needs: build
    runs-on: ubuntu-22.04
    permissions:
      contents: write # required for creating GitHub releases
      id-token: write # required for npm provenance
      attestations: write

    environment:
      name: npm
      url: https://www.npmjs.com/package/${{ needs.build.outputs.name }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v5

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20.x
          registry-url: 'https://registry.npmjs.org/'

      - name: Download build artifacts
        uses: actions/download-artifact@v5
        with:
          name: package-dist
          path: .

      - name: Validate npm token
        run: |
          set -euo pipefail
          [ -n "${{ secrets.NPM_TOKEN }}" ] || { echo "Missing secret NPM_TOKEN" >&2; exit 1; }

      - name: Generate package attestation
        uses: actions/attest-build-provenance@v3
        with:
          subject-path: 'package.json'

      - name: Publish to npm with provenance
        run: npm publish --provenance --access public
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Create GitHub release
        run: |
          gh release create "v${{ needs.build.outputs.version }}" \
            --title "Release v${{ needs.build.outputs.version }}" \
            --generate-notes \
            --latest
        env:
          GH_TOKEN: ${{ github.token }}
